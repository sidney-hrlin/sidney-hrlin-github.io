---
title: Draft - Trajectory Smoothing
date: 2024-05-07 12:03:00 +0800
categories: [draft]
tags: [draft]     # TAG names should always be lowercase
author: <hOrange>
math: true
comments: true
mermaid: true
image: /assets/others/draft.png
---

> *This is post is still in draft stage!*
{: .prompt-warning }

## Error State Model Derivation
Given a time-varying non-linear continuous system 

$$
\dot{x} = f(t,x,u)
$$

Recall the linearization section described in [lqr post](/posts/Linear-Quadratic-Optimal-Tracking-for-Time-Varying-Nonlinear-System/), the continuous-time error space linear system could be expressed as 

$$
\begin{aligned}
\dot{x} &= A(x-x_l) + B(u-u_l) + f(t,x_l,u_l) \\
(\dot{x} - \dot{x_l}) &= A(x-x_l) + B(u-u_l) + [f(t,x_l,u_l) - \dot{x_l}]
\end{aligned}
$$

where

$$
\begin{aligned}
A &= \left.\frac{\partial f}{\partial x}\right \vert_{(x_l,u_l)} \\
B &= \left.\frac{\partial f}{\partial u}\right \vert_{(x_l,u_l)} \\
\end{aligned}
$$

to further simplify the notation, define error state as

$$
\begin{aligned}
\hat{x} &= x - x_l \\
\hat{u} &= u - u_l \\
w &= f(t,x_l,u_l) - \dot{x_l}
\end{aligned}
$$

then, the continuous-time error space system is

$$
\begin{aligned}
\dot{\hat{x}} = A\hat{x}+B\hat{u}+w
\end{aligned}
$$

note that if $(x_l,u_l)$ is generated by system function $\dot{x} = f(t,x,u)$, $w = 0$.

Recall the discretization section described in [mpc post](/posts/Model-Predictive-Control-Part-1-Generized-Problem-Setup), the discrete-time error space linear system could be expressed as 

$$
\begin{aligned}
\hat{x}_{k+1} = A_d\hat{x}_k+B_d\hat{u}_k+w_k
\end{aligned}
$$

where 

$$
\begin{aligned}
A_d &= e^{At}\\
B_d &= \int_{0}^{t}e^{Av}dvB\\
w_k &= \int_{0}^{t}e^{Av}dvw
\end{aligned}
$$

note that if $A$ is invertible, we have

$$
\begin{aligned}
\int_{0}^{t}e^{Av}dv = \left. A^{-1}e^{Av} \right \vert_{0}^{t} = A^{-1}(e^{At} - I)
\end{aligned}
$$

otherwise, $e^{At}$ could be approximated by Taylor expansion

$$
\begin{aligned}
e^{At} = \sum_{k=0}^{\infty}\frac{1}{k!}(At)^k
\end{aligned}
$$

this yields

$$
\begin{aligned}
\int_{0}^{t}e^{Av}dv 
&= \int_{0}^{t}\sum_{k=0}^{\infty}\frac{1}{k!}(Av)^kdv \\
&= \sum_{k=0}^{\infty}\frac{1}{k!}A^{k}\int_{0}^{t}v^{k}dv \\
&= \sum_{k=0}^{\infty}\frac{1}{k!}A^{k}\left. \frac{v^{k+1}}{k+1}\right \vert_{0}^{t} \\
&= \sum_{k=0}^{\infty}\frac{1}{k+1!}A^{k}t^{k+1} \\
&= \sum_{k=1}^{\infty}\frac{1}{k!}A^{k-1}t^k \\
\end{aligned}
$$

It's convenient to convert this model to incremental model

$$
\begin{aligned}
\hat{x}_{k+1} &= A_d\hat{x}_k+B_d\hat{u}_k+w_k \\
&= A_d\hat{x}_k + B_d(\hat{u}_{k-1} + \Delta{\hat{u}_k}) + w_k \\
&= A_d\hat{x}_k + B_d\hat{u}_{k-1} + B_d\Delta{\hat{u}_k} + w_k
\end{aligned}
$$

introducing the augmented state variable $\eta_k$, defined as 

$$
\begin{aligned}
\eta_k = \begin{bmatrix} \hat{x}_{k} \\ \hat{u}_{k-1} \end{bmatrix}
\end{aligned}
$$

the incremental model becomes

$$
\begin{aligned}
\eta_{k+1} = \widetilde{A}_d \eta_k + \widetilde{B}_d \Delta{\hat{u}_k}+\widetilde{w}_k
\end{aligned}
$$

where

$$
\begin{aligned}
\widetilde{A}_d &= \begin{bmatrix} A_d & B_d \\ 0_{n_c \cdot n_s} & I_{n_c \cdot n_c} \end{bmatrix} \\
\widetilde{B}_d &= \begin{bmatrix} B_d \\ I_{n_c \cdot n_c} \end{bmatrix} \\
\widetilde{w}_k &= \begin{bmatrix} w_k \\ 0_{n_c \cdot 1} \end{bmatrix}
\end{aligned}
$$

## Optimal Smoothing Policy

> *For rest of this section, the subscript $k$ is dropped for simplicity!*
{: .prompt-info }

A instantaneous cost for smoothing problems could be expressed as

$$
\begin{aligned}
l &= \underbrace{(x-x_r)^TQ(x-x_r)}_{\text{state deviation cost}} + \underbrace{(u-u_r)^TR(u-u_r)}_{\text{control deviation cost}} + \underbrace{\Delta u^TS\Delta u}_{\text{control rate= cost}} \\
&= [\underbrace{(x-x_l)}_{\hat{x}}-\underbrace{(x_r-x_l)}_{\hat{x}_r}]^TQ[(x-x_l)-(x_r-x_l)] + [\underbrace{u-u_l}_{\hat{u}}-\underbrace{u_r-u_l}_{\hat{u}_r}]^TR[(u-u_l)-(u_r-u_l)] + \Delta u^TS\Delta u \\
&= (\hat{x}-\hat{x}_r)^TQ(\hat{x}-\hat{x}_r) + (\hat{u}-\hat{u}_r)^TR(\hat{u}-\hat{u}_r)+
\Delta u^TS\Delta u \\
\end{aligned}
$$

where

$$
\begin{aligned}
q_{x_k} &= -Q_kx_{r_k} - N_ku_{r_k} \\
r_{u_k} &= -R_ku_{r_k} - N_k^Tx_{r_k} \\
d_{0_k} &= x_{r_k}^TQ_kx_{r_k} + u_{r_k}^TR_ku_{r_k} + 2x_{r_k}^TN_ku_{r_k}
\end{aligned}
$$

The discrete-time iterative riccati equations could be expressed as

$$
\begin{aligned}
Z_k 
&= Q_k+A_d^TZ_{k+1}A_d - (N_k^T+B_d^TZ_{k+1}A_d)^T(R_k+B_d^TZ_{k+1}B_d)^{-1}(N_k^T+B_d^TZ_{k+1}A_d) \\
\\
z_k 
&= -(N_k^T+B_d^TZ_{k+1}A_d)^T(R_k+B_d^TZ_{k+1}B_d)^{-1}[r_{u_k}+B_d^T(Z_{k+1}C_d+z_{x_{k+1}})] + [q_{x_k}+A_d^T(Z_{k+1}C_d+z_{x_{k+1}})] \\
\\
z_{0_k}
&= -[r_{u_k}+B_d^T(Z_{k+1}C_d+z_{x_{k+1}})]^T(R_k+B_d^TZ_{k+1}B_d)^{-1}[r_{u_k}+B_d^T(Z_{k+1}C_d+z_{x_{k+1}})]+d_{0_k}+C_d^TZ_{k+1}C_d+2z_{x_{k+1}}^TC_d+z_{0_{k+1}}
\end{aligned}
$$

The terminal cost is designed as

$$
\begin{aligned}
l_f(x_N,u_N) &= (x_N - x_{r_N})^TQ_f(x_N-x_{r_N}) \\
&= (x_N^TQ_f - x_{r_N}^TQ_f)(x_N-x_{r_N}) \\
&= x_N^TQ_fx_N - 2x_{r_N}^TQ_fx_N + x_{r_N}^TQ_fx_{r_N} \\
&= x_N^TZ_Nx_N + 2z_N^Tx_N+z_{0_N}
\end{aligned}
$$

this yeilds the initial value for $Z_k$, $z_k$ and $z_{0_k}$

$$
\begin{aligned}
Z_N &= Q_f\\
z_N &= -Q_fx_{r_N}\\
z_{0_N} &= x_{r_N}^TQ_fx_{r_N}
\end{aligned}
$$


The optimal policy is

$$
\begin{aligned}
u_k^{\ast} &= K_kx_k+k_k \\
\\
K_k
&= -(R_k+B_d^TZ_{k+1}B_d)^{-1}(N_k^T+B_d^TZ_{k+1}A_d) \\
k_k
&= -(R_k+B_d^TZ_{k+1}B_d)^{-1}(r_{u_k}+B_d^T(Z_{k+1}C_d+z_{x_{k+1}}))
\end{aligned}
$$